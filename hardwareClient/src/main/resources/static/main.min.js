/*! EasyRider build 25-08-2014 */
var app=angular.module("easyrider",["ngRoute"]);app.config(["$locationProvider",function(a){a.html5Mode(!0)}]),app.service("Api",["Connection",function(a){function b(){return g+f++}function c(a){this.subscriptionId=a,this.subscribed=!1,this.snapshot=[]}function d(b){a.on[b]=function(a){var c=a.eventDetails.eventKey.key.join("::");for(var d in j){var e=j[d];if(e.eventType.name==b){var f=!1;for(var g in e.snapshot)if(e.snapshot[g].eventDetails.eventKey.key.join("::")==c){a.eventDetails.removal?e.snapshot.splice(g,1):e.snapshot[g]=a,f=!0;break}f||a.eventDetails.removal||e.snapshot.push(a)}}}}var e=this;e.isAuthenticated=!1;var f=0,g="console";e.objects={Authenticate:function(){this.jsonClass="easyrider.Api$AuthenticateUser"}},e.authenticate=function(b){a.send(b),e.authObject=b},a.onOpen=function(){e.authObject&&a.send(e.authObject)};var h=[],i=[],j={};e.subscribe=function(d,f){var g=b(),i={jsonClass:"easyrider.Events$Subscribe",commandId:{jsonClass:"easyrider.CommandId",id:b()},subscriptionId:g,eventType:{jsonClass:"easyrider.EventType",name:d,sender:{id:"core",jsonClass:"easyrider.ComponentId"}},eventKey:{jsonClass:"easyrider.EventKey",key:f.push?f:f.split(" ")}};e.isAuthenticated&&a.send(i),h.push(i);var k=new c(g);return j[g]=k,k.eventKey=i.eventKey,k.eventType=i.eventType,k.commandId=i.commandId,k},e.command=function(c,d){d.jsonClass=c,d.commandId={id:b()},e.isAuthenticated?a.send(d):i.push(d)},a.on["easyrider.Api$Authentication"]=function(){e.isAuthenticated=!0;for(var b in h)a.send(h[b]);for(b in i)a.send(i[b]);i=[]},a.on["easyrider.Events$Subscribed"]=function(a){var b=j[a.subscriptionId];for(b.subscribed=!0;b.snapshot.length>0;)b.snapshot.pop();for(var c in a.snapshot)b.snapshot.push(a.snapshot[c])},d("easyrider.Applications$ApplicationUpdatedEvent"),d("easyrider.Applications$StageUpdatedEvent"),d("easyrider.Applications$ContainerConfigurationUpdatedEvent")}]),app.service("Applications",["Api","Validators","Utils",function(a,b,c){var d=this;d.subscription=a.subscribe("easyrider.Applications$ApplicationUpdatedEvent",[]),d.list=d.subscription.snapshot,d.addApplicationTemplate=function(){return{jsonClass:"easyrider.Applications$CreateApplication",application:{id:{id:""},properties:[]}}},d.removeApplicationTemplate=function(a){return{jsonClass:"easyrider.Applications$RemoveApplication",applicationId:a}},b.addValidator("easyrider.Applications$CreateApplication",function(a,b){c.isValidId(a.application.id.id)||b.fail("Invalid application id",c.idInfo)})}]),app.service("Command",["Api","Validators",function(a,b){var c=this;c.show=function(a){c.command=a},c.validate=function(){return b.validate(c.command)},c.command=null,c.cancel=function(){c.command=null},c.execute=function(){a.command(c.command.jsonClass,c.command),c.cancel()}}]),app.controller("CommandCtrl",["$scope","Command",function(a,b){a.Command=b;var c="";a.$watch(function(){var d=JSON.stringify(b.command);c!=d&&(c=d,a.validation=b.validate())})}]),app.service("Connection",["$rootScope",function(a){function b(b){a.$apply(function(){d.on[b.jsonClass]?d.on[b.jsonClass](b):console.error("Unhandled message ",b)})}function c(){d.ws=new WebSocket("ws://"+location.host),d.ws.onclose=function(){d.open=!1,setTimeout(function(){c()},500)},d.ws.onopen=function(){d.open=!0;for(var b in e)d.ws.send(e[b]);e=[],a.$apply(d.onOpen)},d.ws.onmessage=function(a){b(JSON.parse(a.data))}}var d=this;d.open=!1,d.on={};var e=[];d.send=function(a){var b=JSON.stringify(a);d.open?d.ws.send(b):e.push(b)},c()}]),app.service("ContainersConfiguration",["Api","Validators","Utils",function(a,b,c){var d=this;d.subscription=a.subscribe("easyrider.Applications$ContainerConfigurationUpdatedEvent",[]),d.list=d.subscription.snapshot,d.addContainerConfigurationTemplate=function(a){return{jsonClass:"easyrider.Applications$CreateContainerConfiguration",container:{id:{stageId:a,id:""},properties:[]}}},d.containersInStage=function(){var a=[];for(var b in d.list){var c=d.list[b];a.push(c)}return a},b.addValidator("easyrider.Applications$CreateContainerConfiguration",function(a,b){c.isValidId(a.container.id.id)||b.fail("Invalid container id",c.idInfo)})}]),app.service("Stages",["Api","Validators","Utils",function(a,b,c){var d=this;d.subscription=a.subscribe("easyrider.Applications$StageUpdatedEvent",[]),d.list=d.subscription.snapshot,d.addStageTemplate=function(a){return{jsonClass:"easyrider.Applications$CreateStage",stage:{id:{applicationId:a||null,id:""},properties:[]}}},d.removeStageTemplate=function(a){return{jsonClass:"easyrider.Applications$RemoveStage",stageId:a}},d.stagesOfApplication=function(a){var b=[];for(var c in d.list)d.list[c].stage.id.applicationId.id==a.id&&b.push(d.list[c]);return b},b.addValidator("easyrider.Applications$CreateStage",function(a,b){a.stage.id.applicationId||b.fail("No application selected","You must select application related to this stage"),c.isValidId(a.stage.id.id)||b.fail("Invalid stage id",c.idInfo)})}]),app.constant("Utils",{isValidId:function(a){return/^[a-zA-Z0-9_]+$/.test(a)},idInfo:"Id must be created from uppercase and lowercase letters, digits and underscore symbol."}),app.service("Validators",function(){var a=this,b={};a.addValidator=function(a,c){b[a]||(b[a]=[]),b[a].push(c)},a.validate=function(a){if(!a)return{alerts:[],canExplain:!1,canExecute:!1};var c=[],d=!0,e=!0,f={noExecute:function(){e=!1},noExplain:function(){d=!1,e=!1},info:function(a,b){c.push({level:"info",title:a,text:b})},warn:function(a,b){c.push({level:"warning",title:a,text:b})},fail:function(a,b){c.push({level:"danger",title:a,text:b}),f.noExplain()}},g=b[a.jsonClass];for(var h in g)g[h](a,f);return{canExecute:e,canExplain:d,alerts:c}}}),app.config(["$routeProvider",function(a){a.when("/application/:appId/stage/:stageId",{templateUrl:"/pages/applicationStage/template.html",controller:["$scope","Stages","$routeParams",function(a,b,c){a.appId=c.appId,a.stageId=c.stageId,a.stage=function(){for(var c in b.list){var d=b.list[c];if(d.stage.id.id==a.stageId&&d.stage.id.applicationId.id==a.appId)return d}}}]})}]),app.config(["$routeProvider",function(a){a.when("/applications",{templateUrl:"/pages/applications/template.html",controller:["$scope","Applications","Command","Stages",function(a,b,c,d){a.Applications=b,a.Stages=d,a.addApplication=function(){c.show(b.addApplicationTemplate())},a.removeApplication=function(a){c.show(b.removeApplicationTemplate(a))},a.addStage=function(a){c.show(d.addStageTemplate(a))}}]})}]),app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"/pages/index/template.html",controller:["$scope","Applications",function(a,b){a.Applications=b}]})}]),app.controller("LoginController",["$scope","Api",function(a,b){a.signIn=function(){b.authenticate(new b.objects.Authenticate)},a.Api=b}]),app.config(["$routeProvider",function(a){a.when("/stages",{templateUrl:"/pages/stages/template.html",controller:["$scope","Stages","Command",function(a,b,c){a.Stages=b,a.addStage=function(){c.show(b.addStageTemplate())}}]})}]),app.directive("selectApplication",function(){return{restrict:"A",templateUrl:"/directives/selectApplication/template.html",scope:{model:"="},controller:["$scope","Applications",function(a,b){a.Applications=b,a.ids=function(){var a=[];for(var c in b.list)a.push(b.list[c].application.id);return a}}]}}),app.directive("stage",function(){return{restrict:"A",scope:{stage:"="},templateUrl:"/directives/stage/template.html",controller:["$scope","ContainersConfiguration","Stages","Command",function(a,b,c,d){a.ContainersConfiguration=b,a.addStage=function(){d.show(c.addStageTemplate())},a.removeStage=function(a){d.show(c.removeStageTemplate(a))},a.addContainer=function(a){d.show(b.addContainerConfigurationTemplate(a))}}]}});