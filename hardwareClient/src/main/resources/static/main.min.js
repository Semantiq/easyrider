/*! EasyRider build 25-08-2014 */
var app=angular.module("easyrider",["ngRoute"]);app.config(["$locationProvider",function(a){a.html5Mode(!0)}]),app.service("Api",["Connection",function(a){function b(){return g+f++}function c(a){this.subscriptionId=a,this.subscribed=!1,this.snapshot=[]}function d(b){a.on[b]=function(a){var c=a.eventDetails.eventKey.key.join("::");for(var d in j){var e=j[d];if(e.eventType.name==b){var f=!1;for(var g in e.snapshot)if(e.snapshot[g].eventDetails.eventKey.key.join("::")==c){a.eventDetails.removal?e.snapshot.splice(g,1):e.snapshot[g]=a,f=!0;break}f||a.eventDetails.removal||e.snapshot.push(a)}}}}var e=this;e.isAuthenticated=!1;var f=0,g="console";e.objects={Authenticate:function(){this.jsonClass="easyrider.Api$AuthenticateUser"}},e.authenticate=function(b){a.send(b),e.authObject=b},a.onOpen=function(){e.authObject&&a.send(e.authObject)};var h=[],i=[],j={};e.subscribe=function(d,f){var g=b(),i={jsonClass:"easyrider.Events$Subscribe",commandId:{jsonClass:"easyrider.CommandId",id:b()},subscriptionId:g,eventType:{jsonClass:"easyrider.EventType",name:d,sender:{id:"core",jsonClass:"easyrider.ComponentId"}},eventKey:{jsonClass:"easyrider.EventKey",key:f.push?f:f.split(" ")}};e.isAuthenticated&&a.send(i),h.push(i);var k=new c(g);return j[g]=k,k.eventKey=i.eventKey,k.eventType=i.eventType,k.commandId=i.commandId,k},e.command=function(c,d){d.jsonClass=c,d.commandId={id:b()},e.isAuthenticated?a.send(d):i.push(d)},a.on["easyrider.Api$Authentication"]=function(){e.isAuthenticated=!0;for(var b in h)a.send(h[b]);for(b in i)a.send(i[b]);i=[]},a.on["easyrider.Events$Subscribed"]=function(a){var b=j[a.subscriptionId];for(b.subscribed=!0;b.snapshot.length>0;)b.snapshot.pop();for(var c in a.snapshot)b.snapshot.push(a.snapshot[c])},d("easyrider.Applications$ApplicationUpdatedEvent"),d("easyrider.Applications$StageUpdatedEvent"),d("easyrider.Applications$ContainerConfigurationUpdatedEvent")}]),app.service("Applications",["Api",function(a){var b=this;b.subscription=a.subscribe("easyrider.Applications$ApplicationUpdatedEvent",[]),b.list=b.subscription.snapshot,b.addApplicationTemplate=function(){return{jsonClass:"easyrider.Applications$CreateApplication",application:{id:{id:""},properties:[]}}},b.removeApplicationTemplate=function(a){return{jsonClass:"easyrider.Applications$RemoveApplication",applicationId:a}}}]),app.service("Command",["Api",function(a){this.show=function(a){this.command=a},this.command=null,this.cancel=function(){this.command=null},this.execute=function(){a.command(this.command.jsonClass,this.command),this.cancel()}}]),app.controller("CommandCtrl",["$scope","Command",function(a,b){a.Command=b}]),app.service("Connection",["$rootScope",function(a){function b(b){a.$apply(function(){d.on[b.jsonClass]?d.on[b.jsonClass](b):console.error("Unhandled message ",b)})}function c(){d.ws=new WebSocket("ws://"+location.host),d.ws.onclose=function(){d.open=!1,setTimeout(function(){c()},500)},d.ws.onopen=function(){d.open=!0;for(var b in e)d.ws.send(e[b]);e=[],a.$apply(d.onOpen)},d.ws.onmessage=function(a){b(JSON.parse(a.data))}}var d=this;d.open=!1,d.on={};var e=[];d.send=function(a){var b=JSON.stringify(a);d.open?d.ws.send(b):e.push(b)},c()}]),app.service("Stages",["Api",function(a){var b=this;b.subscription=a.subscribe("easyrider.Applications$StageUpdatedEvent",[]),b.list=b.subscription.snapshot,b.addStageTemplate=function(a){return{jsonClass:"easyrider.Applications$CreateStage",stage:{id:{applicationId:a||null,id:""},properties:[]}}},b.removeStageTemplate=function(a){return{jsonClass:"easyrider.Applications$RemoveStage",stageId:a}},b.stagesOfApplication=function(a){var c=[];for(var d in b.list)b.list[d].stage.id.applicationId.id==a.id&&c.push(b.list[d]);return c}}]),app.config(["$routeProvider",function(a){a.when("/applications",{templateUrl:"/pages/applications/template.html",controller:["$scope","Applications","Command","Stages",function(a,b,c,d){a.Applications=b,a.Stages=d,a.addApplication=function(){c.show(b.addApplicationTemplate())},a.removeApplication=function(a){c.show(b.removeApplicationTemplate(a))},a.addStage=function(a){c.show(d.addStageTemplate(a))}}]})}]),app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"/pages/index/template.html",controller:["$scope","Applications",function(a,b){a.Applications=b}]})}]),app.controller("LoginController",["$scope","Api",function(a,b){a.signIn=function(){b.authenticate(new b.objects.Authenticate)},a.Api=b}]),app.config(["$routeProvider",function(a){a.when("/stages",{templateUrl:"/pages/stages/template.html",controller:["$scope","Stages","Command",function(a,b,c){a.Stages=b,a.addStage=function(){c.show(b.addStageTemplate())},a.removeStage=function(a){c.show(b.removeStageTemplate(a))}}]})}]),app.directive("selectApplication",function(){return{restrict:"A",templateUrl:"/directives/selectApplication/template.html",scope:{model:"="},controller:["$scope","Applications",function(a,b){a.Applications=b,a.ids=function(){var a=[];for(var c in b.list)a.push(b.list[c].application.id);return a}}]}});