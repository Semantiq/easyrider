<!doctype html>
<html>
	<head>
		<title>EasyRider</title>
		<link rel="stylesheet" href="main.css" />
		<style>* { outline: none; }</style>
	</head>
	<body ng-app="app">
		<div ng-controller="AppsCtrl" class="container-fluid">
			<div class="row-fluid">
				<div class="col-md-12">
					<div class="page-header">
						<h1>EasyRider Apps <small>{{connection}}</small></h1>
						
					</div>
					<div class="page-header" ng-repeat="(app, lastEvent) in status.apps">
						<div class="pull-right btn-toolbar">
							<button class="bnt btn-success btn-lg" ng-click="start(app)">Start</button>
							<button class="bnt btn-danger btn-lg" ng-click="stop(app)">Stop</button>
						</div>
						<h2>{{app}} <small>{{lastEvent.process}}</small> <small>{{lastEvent.build}}</small></h2>
						<br style="clear:both" />
					</div>
				</div>
			</div>
		</div>
		<script src="angular.min.js"></script>
		<script>
			function IO($scope) {
				var me = this;
				me.connect = function() {
					me.ws = new WebSocket("ws://" + window.location.host + "/api");
					me.ws.onmessage = function(e) {
						var msg = JSON.parse(e.data);
						$scope.$emit("newStatus", msg);
					};
					me.ws.onclose = function() {
						$scope.$apply(function() {
							$scope.connection = "Offline";
						});
						setTimeout(function() {
							me.connect();
						}, 100);
					};
					me.ws.onopen = function() {
						$scope.$apply(function() {
							$scope.connection = "Online";
						});
					};
				};
				me.send = function(obj) {
					me.ws.send(JSON.stringify(obj));
				};
				me.connect();
			}

			var app = new angular.module("app", []);

			app.controller("AppsCtrl", function($scope) {
				var io = new IO($scope);
				$scope.start = function(app) {
					io.send({ jsonClass: "eu.semantiq.easyrider.supervisor.AppSupervisor$Start", app: app });
				};
				$scope.stop = function(app) {
					io.send({ jsonClass: "eu.semantiq.easyrider.supervisor.AppSupervisor$Stop", app: app });
				};

				$scope.$on("newStatus", function(e, status) {
					$scope.$apply(function() {
						$scope.status = status;
					});
				});
			});
		</script>
	</body>
</html>